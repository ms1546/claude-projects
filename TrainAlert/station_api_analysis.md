# 駅検索タイムアウト問題の分析と機能改善提案

## 1. タイムアウトの根本原因

### Overpass APIの問題
- **無料公開API**のため、サーバー負荷が高いとレスポンスが遅い
- **日本の駅データ**がOpenStreetMapに完全に登録されていない可能性
- **クエリの複雑さ**により検索に時間がかかる

### 現在の実装の問題
1. **ネットワークチェック**でGoogleにアクセスしているが、これ自体が遅延の原因になる可能性
2. **検索のたびにAPI呼び出し**でサーバーに負荷をかけている
3. **キャッシュが効果的に使われていない**

## 2. 解決案

### 短期的解決案
1. **ローカルデータベースの使用**
   - 主要駅のデータをアプリ内に持つ
   - 初回起動時に駅データをダウンロード

2. **別のAPIへの切り替え**
   - HeartRails Express API（日本の鉄道専門）
   - 駅すぱあとWebサービス API

3. **キャッシュの強化**
   - 検索結果を永続化
   - オフライン対応

## 3. 機能改善提案

### 「駅から検索」の距離ベース設定 ✅

**メリット**:
- より直感的（「新宿駅から500m以内」など）
- GPSの精度と相性が良い
- バッテリー消費を最適化できる

**実装案**:
```swift
// 現在
notificationTime: Int16  // 何分前

// 変更後
notificationDistance: Double  // 何メートル以内
```

**UI例**:
- 100m, 300m, 500m, 1km, 2km から選択
- スライダーで細かく調整も可能

### 「経路から検索」の何駅前設定 ✅

**メリット**:
- 長距離移動時に便利（「3駅前に通知」など）
- 時間よりも確実性が高い
- 遅延に強い

**実装案**:
```swift
// 現在
notificationMinutes: Int16  // 何分前

// 追加
notificationStationsBefore: Int16  // 何駅前
notificationType: String  // "time" or "station" or "both"
```

**UI例**:
- 「通知タイミング」セクションに選択肢を追加
  - 時間で設定（5分前、10分前...）
  - 駅数で設定（1駅前、2駅前...）
  - 両方で設定（どちらか早い方）

## 4. 推奨される実装順序

1. **まず駅データのローカル化**を検討
   - 日本の主要駅データをJSONで持つ
   - 起動時に読み込み

2. **距離ベースアラート**の実装
   - 既存のnotificationDistanceフィールドを活用
   - UIの変更のみで対応可能

3. **何駅前アラート**の実装
   - 路線情報と駅順序が必要
   - ODPTAPIとの連携強化が必要

## 5. 注意点

- **位置情報の精度**：地下鉄では精度が落ちる
- **バッテリー消費**：距離ベースは頻繁な位置情報更新が必要
- **路線データ**：何駅前機能には正確な路線データが必須