# チケット #017: 位置情報・通知設定機能の実装

## 概要
位置情報サービスと通知設定機能を完全に実装し、ユーザーが駅に接近した際に確実に通知を受け取れるようにする。

## ステータス
- [ ] Not Started
- [ ] In Progress  
- [ ] Completed

## 背景
現在、位置情報と通知の基本的な実装はあるが、実際の動作が不完全。要件定義に基づいて完全な実装を行う必要がある。

## 詳細要件

### 1. 位置情報機能
- **権限管理**
  - 初回起動時の位置情報許可リクエスト
  - 設定画面での権限状態表示
  - 権限が無効な場合の誘導UI

- **位置情報追跡**
  - バックグラウンドでの継続的な位置情報取得
  - 省電力を考慮した位置情報更新頻度の最適化
  - 駅接近検知アルゴリズムの実装

- **精度管理**
  - 駅からの距離に応じた位置情報精度の調整
  - 5km以上: kCLLocationAccuracyKilometer
  - 1-5km: kCLLocationAccuracyHundredMeters  
  - 1km未満: kCLLocationAccuracyBest

### 2. 通知機能
- **通知設定**
  - 通知許可リクエストの実装
  - 通知音の選択機能
  - バイブレーションのオン/オフ
  - 通知の繰り返し間隔設定（スヌーズ）

- **通知タイミング**
  - 駅到着予定時刻の5分前（デフォルト）
  - ユーザーによるカスタマイズ可能（1-30分）
  - 位置情報ベースでの補正

- **通知内容**
  - AI生成メッセージの表示
  - 駅名と残り時間/距離の表示
  - アクションボタン（確認、スヌーズ）

### 3. バックグラウンド処理
- **Background Modes設定**
  - Location updates
  - Background fetch
  - Remote notifications

- **バッテリー最適化**
  - Significant location changeの活用
  - Region monitoringの実装
  - 適切な位置情報更新間隔

## 技術仕様
- Core Location Frameworkの活用
- UNUserNotificationCenterの実装
- BackgroundTasksの設定
- 省電力アルゴリズムの実装

## タスクリスト
- [ ] 位置情報権限リクエストUIの実装
- [ ] LocationManagerの完全実装
  - [ ] バックグラウンド位置情報更新
  - [ ] 距離に応じた精度調整
  - [ ] Region monitoring実装
- [ ] 通知設定画面の実装
  - [ ] 通知音選択
  - [ ] バイブレーション設定
  - [ ] 通知タイミング設定
- [ ] 通知マネージャーの改修
  - [ ] スヌーズ機能
  - [ ] アクションボタン処理
- [ ] バックグラウンドタスクの実装
- [ ] バッテリー使用量の最適化
- [ ] 設定画面での権限状態表示
- [ ] Unit Testの作成
- [ ] 実機でのバックグラウンド動作テスト

## 依存関係
- チケット#004（位置情報サービス基本実装）- 完了済み
- チケット#005（通知システム基本実装）- 完了済み

## 完了条件
- [ ] バックグラウンドで位置情報が正常に更新される
- [ ] 駅接近時に確実に通知が届く
- [ ] バッテリー消費が1時間あたり5%以下
- [ ] すべての設定項目が正常に動作する
- [ ] iOS設定アプリとの連携が正常
- [ ] すべてのテストがパス

## 見積もり工数
- 3-4日

## リスク
- バックグラウンド処理の制限
- バッテリー消費量の増加
- 位置情報精度の問題

## 注意事項
- Appleのバックグラウンド処理ガイドラインに準拠
- プライバシーに配慮した実装
- TestFlightでの実機テストが必須