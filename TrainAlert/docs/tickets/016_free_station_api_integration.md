# チケット #016: 無料駅データAPI統合

## 概要
現在ハードコードされている駅データを、無料のAPIから動的に取得する仕組みに変更する。趣味利用でお金のかからないAPIを使用し、アプリ内に駅データを持たないようにする。

## ステータス
- [ ] Not Started
- [x] In Progress  
- [ ] Completed

## 背景
現在、StationAPIClientには主要駅のデータがハードコードされているが、これを外部APIから取得する仕組みに変更する必要がある。

## 詳細要件

### API候補
1. **HeartRails Express API** (現在一部使用中)
   - 無料・申請不要
   - 路線・駅情報の取得が可能
   - 位置情報からの最寄り駅検索対応
   - エンドポイント例：
     - `http://express.heartrails.com/api/json?method=getStations&line=JR山手線`
     - `http://express.heartrails.com/api/json?method=getStations&x=経度&y=緯度`

2. **駅データ.jp API**
   - 無料版あり（制限あり）
   - 全国の駅情報を網羅
   - 申請が必要な場合あり

### 実装内容
1. **StationAPIClientの改修**
   - ハードコードされた駅データを削除
   - API経由での駅検索機能実装
   - キャッシュ機構の実装（API呼び出し削減）

2. **駅検索機能の拡張**
   - 路線名からの駅一覧取得
   - 駅名の部分一致検索
   - 位置情報からの最寄り駅検索
   - 都道府県別の駅検索

3. **エラーハンドリング**
   - オフライン時の対応
   - API制限エラーの処理
   - タイムアウト処理

## 技術仕様
- 使用API: HeartRails Express API（推奨）
- キャッシュ: UserDefaultsまたはCore Dataに最近検索した駅を保存
- 非同期処理: async/awaitパターンを使用

## タスクリスト
- [x] APIの調査と選定（HeartRails Express APIを使用）
- [x] StationAPIClientからハードコードデータを削除
- [x] API通信処理の実装
  - [x] getNearbyStationsがAPIを使用するよう実装済み
  - [x] searchStationsをAPI対応に改修
  - [x] 路線別駅取得機能の実装
- [x] 駅データモデルの調整（API応答に合わせる）
  - [x] StationModelのlinesプロパティをvarに変更
- [x] キャッシュ機構の実装
  - [x] 検索結果のキャッシュ機能追加
  - [x] 24時間の有効期限設定
- [x] エラーハンドリングの実装
  - [x] API失敗時のフォールバック実装
  - [x] オフライン用のローカルデータ保持
- [ ] 駅検索UIの調整
- [ ] Unit Testの作成
- [ ] 統合テストの実施

## 依存関係
- なし（独立したタスク）

## 完了条件
- [ ] すべての駅データがAPI経由で取得される
- [ ] オフライン時でも最近検索した駅が利用可能
- [ ] 検索レスポンスが1秒以内
- [ ] API制限に引っかからない実装
- [ ] すべてのテストがパス

## 見積もり工数
- 2-3日

## リスク
- API制限による機能制限
- ネットワーク依存性の増加
- 応答速度の低下

## 注意事項
- API利用規約を確認し、準拠すること
- 将来的な有料プラン移行の可能性を考慮した設計
- レート制限を考慮したリトライ処理の実装