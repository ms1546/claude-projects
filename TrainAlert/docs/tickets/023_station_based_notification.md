# Ticket #023: 駅数ベース通知機能

## 概要
到着駅の○駅前で通知する機能を実装する。

## 優先度: Medium
## 見積もり: 12h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 実装完了日
2025-08-20

## 実装の詳細
- StationCountCalculatorクラスを新規作成し、停車駅リストの取得と通知駅の計算ロジックを実装
- TimetableAlertSetupViewに駅数ベース通知選択時の通知駅表示を統合
- Core Dataには既存のnotificationStationsBeforeプロパティを使用
- ODPT APIから実際の停車駅データを取得して使用
- モックデータ/ハードコーディングを削除し、APIからの動的データ取得に変更
- 出発駅での通知を無効化し、適切なエラーメッセージを表示

## タスク
### API実装
- [x] TrainTimetable APIクライアント実装
  - [x] エンドポイント定義
  - [x] 列車番号による時刻表取得
  - [x] エラーハンドリング
- [x] 停車駅リスト取得機能
  - [x] APIレスポンス解析
  - [x] 停車駅データモデル
  - [x] 種別による停車駅フィルタリング

### ビジネスロジック
- [x] 駅数カウントロジック
  - [x] 快速・特快等の通過駅除外
  - [x] 停車駅のみカウント
  - [x] 逆算アルゴリズム実装
- [x] 通知駅特定ロジック
  - [x] 到着駅からの逆算
  - [x] 通知タイミング計算
  - [x] 予定時刻の取得

### UI実装
- [x] 通知タイミング選択UI
  - [x] 時間/駅数切り替えトグル
  - [x] 駅数選択（1〜10駅）
  - [x] 選択値の保存
- [x] 通知駅プレビューUI
  - [x] 停車駅リスト表示
  - [x] 通知駅のハイライト
  - [x] 到着予定時刻表示
- [x] 駅リストのビジュアル表示
  - [x] 路線図風UI
  - [x] 停車駅マーカー
  - [ ] 現在位置表示

### データ層実装
- [x] Core Dataモデル拡張
  - [x] 駅数ベース設定の保存
  - [x] 通知駅情報の保存
  - [x] マイグレーション対応

## 実装ガイドライン
- 種別（各停/快速/特快等）に応じた停車駅の正確な把握
- ユーザーが直感的に理解できるプレビュー表示
- 通過駅は駅数にカウントしない
- 駅数は停車駅のみをカウント

## 完了条件（Definition of Done）
- [x] 駅数で通知タイミングを設定できる
- [x] 通知される駅が事前に確認できる
- [x] 快速等の種別に対応している
- [x] 正しいタイミングで通知される

## テスト方法
1. 各停/快速/特快でそれぞれテスト
2. 通過駅がある路線での動作確認
3. プレビューと実際の通知駅の一致確認
4. 異なる駅数設定での動作確認

## 依存関係
- チケット#022（基本実装）

## 成果物
- TrainTimetableAPIClient.swift
- StationCountNotificationView.swift
- StationPreviewView.swift
- StationCountCalculator.swift

## 備考
- 通過駅の扱いが重要なポイント
- ユーザビリティを考慮したプレビュー機能
