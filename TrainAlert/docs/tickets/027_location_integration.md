# Ticket #027: 位置情報連携機能

## 概要
時刻表ベースの通知と位置情報を組み合わせて、より正確な通知を実現する。

## 優先度: Medium
## 見積もり: 16h
## ステータス: [ ] Not Started / [ ] In Progress / [ ] Completed

## タスク
### 位置情報連携実装
- [ ] 位置情報と時刻表の照合ロジック
  - [ ] 現在位置と駅の距離計算
  - [ ] 時刻表の予定時刻との比較
  - [ ] ズレの検出アルゴリズム
- [ ] 駅接近検知の精度向上
  - [ ] ジオフェンシングの最適化
  - [ ] 複数の検知手法の組み合わせ
  - [ ] 誤検知の防止ロジック

### ハイブリッド判定システム
- [ ] 判定ロジックの実装
  - [ ] HybridNotificationManager作成
  - [ ] 時刻表ベースの判定
  - [ ] 位置情報ベースの判定
  - [ ] 両者の統合判定
- [ ] ズレ検出と補正機能
  - [ ] 予定と実際の差分計算
  - [ ] 自動補正アルゴリズム
  - [ ] 補正履歴の記録

### GPS精度対応
- [ ] GPS精度に応じた動作切り替え
  - [ ] 精度レベルの判定
  - [ ] 低精度時のフォールバック
  - [ ] 地下鉄対応モード
- [ ] バッテリー消費の最適化
  - [ ] 位置情報更新頻度の動的調整
  - [ ] 必要時のみの高精度モード
  - [ ] 省電力モードの実装

### UI実装
- [ ] デバッグ用の状態表示
  - [ ] 現在の判定モード表示
  - [ ] GPS精度インジケータ
  - [ ] 時刻表とのズレ表示
- [ ] ユーザー向け情報表示
  - [ ] 現在の動作モード
  - [ ] 次回通知予定
  - [ ] 信頼度表示

### データ層実装
- [ ] 位置情報履歴の保存
  - [ ] Core Dataモデル拡張
  - [ ] 位置情報ログ
  - [ ] 精度情報の記録
- [ ] 学習データの蓄積
  - [ ] 実際の到着時刻記録
  - [ ] ズレパターンの分析
  - [ ] 将来的な予測精度向上

## 実装ガイドライン
- 時刻表をメインとし、位置情報で補強
- バッテリー効率を最優先
- ユーザーに透明性のある動作
- 段階的な精度向上を目指す

## 完了条件（Definition of Done）
- [ ] 時刻表と位置情報の両方で判定される
- [ ] GPS不調時も通知が動作する
- [ ] より正確なタイミングで通知される
- [ ] バッテリー消費が過度でない

## テスト方法
1. 地上路線での動作確認
2. 地下鉄での動作確認
3. GPS精度が低い環境でのテスト
4. バッテリー消費量の測定

## 依存関係
- チケット#022（基本実装）
- チケット#004（位置情報サービス実装）- 完了済み

## 成果物
- HybridNotificationManager.swift
- LocationAccuracyManager.swift
- GPSFallbackHandler.swift
- HybridStatusView.swift

## 備考
- 将来的にはAI学習による精度向上も検討
- プライバシーに配慮した実装