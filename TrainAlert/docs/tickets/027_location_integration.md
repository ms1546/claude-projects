# Ticket #027: 位置情報連携機能

## 概要
時刻表ベースの通知と位置情報を組み合わせて、より正確な通知を実現する。

## 優先度: Medium
## 見積もり: 16h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 実装完了日
2025-08-24 (PR#41)

## タスク
### 位置情報連携実装
- [x] 位置情報と時刻表の照合ロジック
  - [x] 現在位置と駅の距離計算
  - [x] 時刻表の予定時刻との比較
  - [x] ズレの検出アルゴリズム
- [x] 駅接近検知の精度向上
  - [x] ジオフェンシングの最適化
  - [x] 複数の検知手法の組み合わせ
  - [x] 誤検知の防止ロジック

### ハイブリッド判定システム
- [x] 判定ロジックの実装
  - [x] HybridNotificationManager作成
  - [x] 時刻表ベースの判定
  - [x] 位置情報ベースの判定
  - [x] 両者の統合判定
- [x] ズレ検出と補正機能
  - [x] 予定と実際の差分計算
  - [x] 自動補正アルゴリズム
  - [x] 補正履歴の記録

### GPS精度対応
- [x] GPS精度に応じた動作切り替え
  - [x] 精度レベルの判定
  - [x] 低精度時のフォールバック
  - [x] 地下鉄対応モード
- [x] バッテリー消費の最適化
  - [x] 位置情報更新頻度の動的調整
  - [x] 必要時のみの高精度モード
  - [x] 省電力モードの実装

### UI実装
- [x] デバッグ用の状態表示
  - [x] 現在の判定モード表示
  - [x] GPS精度インジケータ
  - [x] 時刻表とのズレ表示
- [x] ユーザー向け情報表示
  - [x] 現在の動作モード
  - [x] 次回通知予定
  - [x] 信頼度表示

### データ層実装
- [x] 位置情報履歴の保存
  - [x] Core Dataモデル拡張
  - [x] 位置情報ログ
  - [x] 精度情報の記録
- [x] 学習データの蓄積
  - [x] 実際の到着時刻記録
  - [x] ズレパターンの分析
  - [x] 将来的な予測精度向上

## 実装ガイドライン
- 時刻表をメインとし、位置情報で補強
- バッテリー効率を最優先
- ユーザーに透明性のある動作
- 段階的な精度向上を目指す

## 完了条件（Definition of Done）
- [x] 時刻表と位置情報の両方で判定される
- [x] GPS不調時も通知が動作する
- [x] より正確なタイミングで通知される
- [x] バッテリー消費が過度でない

## テスト方法
1. 地上路線での動作確認
2. 地下鉄での動作確認
3. GPS精度が低い環境でのテスト
4. バッテリー消費量の測定

## 依存関係
- チケット#022（基本実装）
- チケット#004（位置情報サービス実装）- 完了済み

## 成果物
- HybridNotificationManager.swift
- LocationAccuracyManager.swift
- GPSFallbackHandler.swift
- HybridStatusView.swift

## 備考
- 将来的にはAI学習による精度向上も検討
- プライバシーに配慮した実装

## 実装の詳細
- **HybridNotificationManager**: 時刻表と位置情報の統合判定を行うメインコンポーネント
  - 4つの動作モード（時刻表のみ、位置情報のみ、ハイブリッド、フォールバック）
  - 時刻表と実際の位置情報のズレを検出・表示
  - 信頼度ベースの判定ロジック

- **LocationAccuracyManager**: GPS精度管理とバッテリー最適化
  - 5段階の精度レベル（高精度、中精度、低精度、非常に低精度、利用不可）
  - 環境に応じた動作モード切り替え（屋外、屋内、地下、トンネル）
  - バッテリー残量に応じた自動最適化

- **GPSFallbackHandler**: GPS不調時の処理
  - 5つのフォールバック戦略（時刻表のみ、最後の既知位置、駅順序推定、手動確認、複合戦略）
  - 駅通過履歴を利用した位置推定
  - GPS復帰時の自動切り替え

- **LocationHistory Core Dataエンティティ**: 位置情報履歴の保存
  - 位置、精度、速度、環境、信頼度などを記録
  - 将来的な学習データとして活用可能

- **HybridStatusView**: ユーザー向けの状態表示UI
  - 現在の動作モード、GPS精度、フォールバック状態を視覚的に表示
  - デバッグ情報の表示機能
  - 設定画面から詳細設定へのアクセス

- **既存ビューへの統合**:
  - TimetableAlertSetupViewにハイブリッド通知カードを追加
  - SettingsViewにハイブリッド通知セクションを追加
  - アラート保存時に自動的に監視を開始