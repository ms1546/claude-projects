# Ticket #038: 通知履歴記録バグ修正

## 概要
通知が発火しても履歴に記録されないバグを修正する。ユーザーが通知を受け取ったにも関わらず、履歴画面に表示されない問題への対応。

## 優先度: High
## 見積もり: 8h
## ステータス: [ ] Not Started / [x] In Progress / [ ] Completed

## 問題の詳細
- 通知は正常に発火するが、Core Dataへの履歴保存が失敗している
- バックグラウンドでの通知処理時に履歴記録が漏れている可能性
- 通知ハンドラーと履歴記録処理の連携不足

## タスク
### 調査・分析
- [ ] 現在の履歴記録処理を確認
  - [ ] NotificationHistoryエンティティの実装確認
  - [ ] 通知受信時の履歴保存処理
  - [ ] バックグラウンドでの保存処理
- [ ] 履歴が記録されないケースの特定
  - [ ] フォアグラウンド/バックグラウンドの違い
  - [ ] 通知タイプによる違い
  - [ ] Core Dataのコンテキスト問題

### 実装
- [ ] 通知履歴記録の改善
  - [ ] UNNotificationResponseハンドラーでの確実な記録
  - [ ] バックグラウンドコンテキストでの保存処理
  - [ ] 保存失敗時のリトライ機構
- [ ] 履歴記録の検証機能
  - [ ] 保存成功の確認ログ
  - [ ] 保存失敗時のエラーログ
  - [ ] デバッグ用の履歴確認画面
- [ ] 通知と履歴の紐付け強化
  - [ ] 通知IDと履歴IDの関連付け
  - [ ] 重複履歴の防止
  - [ ] タイムスタンプの正確な記録

### UI改善
- [ ] 履歴画面のリアルタイム更新
- [ ] 履歴が記録されない場合の表示
- [ ] 履歴の手動リフレッシュ機能

## 実装ガイドライン
- Core Dataの保存は必ずバックグラウンドキューで実行
- 保存処理は同期的に完了を待つ
- エラーハンドリングを充実させる

## 完了条件（Definition of Done）
- [ ] 全ての通知が確実に履歴に記録される
- [ ] フォアグラウンド/バックグラウンド両方で動作
- [ ] 履歴画面で全ての通知履歴が確認できる
- [ ] 保存エラーが発生した場合、適切にログが記録される

## テスト方法
1. 各種通知（時刻表、位置情報、ハイブリッド）を設定
2. アプリをバックグラウンドに移行
3. 通知を受信
4. 履歴画面で記録を確認
5. Core Dataの直接確認

## 依存関係
- なし（緊急バグ修正のため独立して実装可能）

## 成果物
- NotificationHistoryManager.swift（履歴記録の一元管理）
- 履歴保存処理の改善
- バックグラウンド保存の実装
- デバッグログ機能

## 備考
- ユーザーの信頼性に関わる重要なバグ
- 位置情報通知、時刻表通知、ハイブリッド通知全てで動作確認が必要
