# Ticket #038: 通知履歴記録バグ修正

## 概要
通知が発火しても履歴に記録されないバグを修正する。ユーザーが通知を受け取ったにも関わらず、履歴画面に表示されない問題への対応。

## 優先度: High
## 見積もり: 8h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 問題の詳細
- 通知は正常に発火するが、Core Dataへの履歴保存が失敗している
- バックグラウンドでの通知処理時に履歴記録が漏れている可能性
- 通知ハンドラーと履歴記録処理の連携不足

## タスク
### 調査・分析
- [x] 現在の履歴記録処理を確認
  - [x] NotificationHistoryエンティティの実装確認
  - [x] 通知受信時の履歴保存処理
  - [x] バックグラウンドでの保存処理
- [x] 履歴が記録されないケースの特定
  - [x] フォアグラウンド/バックグラウンドの違い
  - [x] 通知タイプによる違い
  - [x] Core Dataのコンテキスト問題

### 実装
- [x] 通知履歴記録の改善
  - [x] UNNotificationResponseハンドラーでの確実な記録
  - [x] バックグラウンドコンテキストでの保存処理
  - [x] 保存失敗時のリトライ機構
- [x] 履歴記録の検証機能
  - [x] 保存成功の確認ログ
  - [x] 保存失敗時のエラーログ
  - [x] デバッグ用の履歴確認画面
- [x] 通知と履歴の紐付け強化
  - [x] 通知IDと履歴IDの関連付け
  - [x] 重複履歴の防止
  - [x] タイムスタンプの正確な記録

### UI改善
- [x] 履歴画面のリアルタイム更新
- [x] 履歴が記録されない場合の表示
- [x] 履歴の手動リフレッシュ機能

## 実装ガイドライン
- Core Dataの保存は必ずバックグラウンドキューで実行
- 保存処理は同期的に完了を待つ
- エラーハンドリングを充実させる

## 完了条件（Definition of Done）
- [x] 全ての通知が確実に履歴に記録される
- [x] フォアグラウンド/バックグラウンド両方で動作
- [x] 履歴画面で全ての通知履歴が確認できる
- [x] 保存エラーが発生した場合、適切にログが記録される

## テスト方法
1. 各種通知（時刻表、位置情報、ハイブリッド）を設定
2. アプリをバックグラウンドに移行
3. 通知を受信
4. 履歴画面で記録を確認
5. Core Dataの直接確認

## 依存関係
- なし（緊急バグ修正のため独立して実装可能）

## 成果物
- NotificationHistoryManager.swift（履歴記録の一元管理）
- 履歴保存処理の改善
- バックグラウンド保存の実装
- デバッグログ機能

## 備考
- ユーザーの信頼性に関わる重要なバグ
- 位置情報通知、時刻表通知、ハイブリッド通知全てで動作確認が必要

## 実装完了日
2025-08-23

## 実装の詳細
- NotificationHistoryManagerクラスを新規作成し、通知履歴の保存を一元管理
- NotificationManagerのdelegateメソッド（willPresent、didReceive）で履歴を保存するように修正
- AlertMonitoringServiceでもNotificationHistoryManagerを使用するように変更
- HybridNotificationManagerの通知にもuserInfoを追加して履歴保存を可能に
- 保存失敗時は最大3回まで5秒間隔でリトライする機能を実装
- HistoryViewModelは既にCore Data変更を監視してリアルタイム更新する仕組みがあることを確認

### 追加修正（2025-08-23）
- **重複通知問題の修正**:
  - NotificationHistoryManagerの重複チェックをisUserInteractionフラグに関係なく常に実行
  - チェック期間を5秒から30秒に延長
  - 駅名と通知タイプの組み合わせで重複を判定
- **通知の重複送信防止**:
  - AlertMonitoringServiceでnotifiedAlertsのチェックを追加
  - 一度通知したアラートは同じセッション中に再送信しない
- **「不明な駅」問題の修正**:
  - 複数のキー名（stationName、arrivalStation）から駅名を取得
  - 通知作成時にalertIdを確実に含めるよう修正
