# Ticket #026: 乗り換え対応機能

## 概要
経路検索機能を拡張し、複数路線を跨ぐ乗り換えルートの検索とアラート設定を可能にする。

## 優先度: High
## 見積もり: 24h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 実装開始日: 2025-08-24
## 実装完了日: 2025-08-24 (PR: pending)

## タスク
### 経路検索の拡張
- [x] 現状の経路検索機能の分析
  - [x] 単一路線内のみ対応を確認
  - [x] ODPT APIの制限を確認
- [x] 駅間接続データの実装
  - [x] 乗り換え可能駅のマッピング
  - [x] 路線間接続情報の管理
  - [x] 徒歩乗り換え情報の追加
- [x] 経路探索アルゴリズムの実装
  - [x] ダイクストラ法またはA*アルゴリズムの実装
  - [x] 乗り換え時間の考慮
  - [x] 複数経路候補の生成

### データモデル実装
- [x] RouteSearchResultの複数sections対応（既存）
- [ ] 乗り換え駅情報の拡張
  - [ ] 乗り換え時間の追加
  - [ ] プラットフォーム情報
  - [ ] 徒歩移動の考慮
- [ ] 時刻表データの統合
  - [ ] 複数路線の時刻表結合
  - [ ] 乗り換え可能時刻の計算

### API実装
- [ ] 複数路線の時刻表取得
  - [ ] 並列API呼び出し
  - [ ] データのキャッシング
  - [ ] エラーハンドリング
- [ ] 乗り換え駅の特定
  - [ ] 駅名の完全一致/部分一致
  - [ ] 路線別駅IDのマッピング

### UI更新
- [x] RouteSearchViewの拡張
  - [x] 乗り換えルートの表示
  - [x] 各区間の詳細表示
  - [x] 乗り換え時間の表示
- [ ] TimetableAlertSetupViewの対応
  - [x] 乗り換え駅での通知設定（削除済み）
  - [ ] 複数区間を考慮した通知設定

### ビジネスロジック
- [ ] 最適経路の選定
  - [ ] 所要時間優先
  - [ ] 乗り換え回数優先
  - [ ] 到着時刻の正確性優先
- [ ] 通知タイミングの計算
  - [ ] 各区間での通知
  - [ ] 乗り換え駅での通知
  - [ ] 最終到着駅での通知

## 実装ガイドライン
- 初期版は主要な乗り換え駅に対応
- 東京都内の主要路線を優先
- 乗り換え時間は固定値（3-5分）で開始
- 既存の経路検索UIを活用

## 完了条件（Definition of Done）
- [x] 経路検索で複数路線を跨ぐルートが表示される
- [x] transferCountが正しく計算される
- [x] 各区間（sections）が正しく生成される
- [ ] 乗り換えルートでアラート設定ができる
- [ ] 乗り換え駅での通知が設定できる

## テスト方法
1. 異なる路線の駅間で経路検索
2. 乗り換えありルートの表示確認
3. アラート設定の動作確認
4. 通知タイミングの確認

## 依存関係
- チケット#018（時刻表統合）- 完了済み
- チケット#004（位置情報サービス）- 完了済み

## 成果物
- StationConnectionManager.swift（新規）
- RouteSearchAlgorithm.swift（新規）
- RouteSearchViewModel.swift（更新）
- ODPTAPIClient.swift（更新）

## 備考
- ODPT APIの制限により、独自の経路探索実装が必要
- 初期版は基本的な乗り換えパターンのみ対応
- 将来的にはより高度な経路探索アルゴリズムに拡張可能

## 実装の詳細
### 部分実装として完了した機能（2025-08-24）
- StationConnectionManager.swift: 主要な乗り換え駅のマッピングデータを実装
- RouteSearchAlgorithm.swift: 簡易的な経路探索アルゴリズム（直通＋1回乗換）を実装
- RouteSearchViewModel.swift: 異なる路線間の検索時に乗り換え経路探索を実行
- RouteSearchView.swift: 乗り換えルートの詳細表示（区間ごとの路線・時刻・乗換情報）

### 未実装の機能
- リアルタイムの時刻表データとの統合（現在は推定時刻）
- 複雑な乗り換え（2回以上）への対応
- 乗り換えルートでのアラート設定機能
- 乗り換え駅での通知設定機能
- より正確な所要時間計算（現在は固定値）

### 今後の拡張（API変更後に実装推奨）
- **動的経路探索アルゴリズム**: 時刻表データをベースにしたグラフ構築とダイクストラ法
  - 現在のハードコーディング方式から、実際のAPIデータを使用した動的な経路探索へ
  - ODPT APIの`connectingRailway`フィールドの活用（現状は不完全）
  - HeartRails APIとの連携による同名駅の自動検出
  - API呼び出し最適化（キャッシュ、バッチ処理）
- **理由**: 現在のモックデータ実装では対応路線が限定的で、実用性に欠ける
- **必要なAPI変更**:
  - ODPT APIから完全な駅接続情報を取得
  - または独自の駅接続データベースの構築
  - 時刻表データと駅データの効率的な統合
