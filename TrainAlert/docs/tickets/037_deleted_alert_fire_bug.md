# Ticket #037: 削除済みアラート発火バグ修正

## 概要
削除したはずのアラートが発火される重大なバグを修正する。ユーザーが削除したアラートに対する通知が依然として発火されてしまう問題への対応。

## 優先度: High
## 見積もり: 6h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 実装完了日
2025-08-24

## 実装の詳細
- AlertDeletionManager.swiftを新規作成し、削除処理を一元管理
- HomeViewModelのdeleteAlertメソッドを修正してAlertDeletionManagerを使用
- AlertMonitoringServiceにremoveAlertメソッドを追加
- 以下の通知を確実にキャンセルするよう実装：
  - 基本の時刻表通知
  - 繰り返し通知（全曜日分）
  - 位置情報ベースの通知
  - ハイブリッド通知
  - スヌーズ通知（将来の実装用）
- 削除後の検証機能を追加（残存通知の確認と再キャンセル）
- AlertDeletionTestsでユニットテストを実装

## 問題の詳細
- 削除操作を行ったアラートが、実際には通知システムから削除されていない
- バックグラウンドタスクやスケジュール済み通知が残存している可能性
- Core Dataの削除とNotificationCenterの同期が取れていない

## タスク
### 調査・分析
- [x] 削除処理の現在の実装を確認
  - [x] Core Dataの削除処理
  - [x] UNUserNotificationCenterからの削除処理
  - [x] バックグラウンドタスクの削除処理
- [x] 削除タイミングと通知発火のタイムラグを調査
- [x] ログ機能を追加して削除プロセスを追跡

### 実装
- [x] 削除処理の改善
  - [x] Core Data削除前に通知をキャンセル
  - [x] 全ての関連通知IDを取得して削除
  - [x] バックグラウンドタスクも含めて削除
- [x] 削除確認機能の実装
  - [x] 削除後の通知一覧を確認
  - [x] 削除が完了したことを検証
- [x] 削除失敗時のリトライ機構
  - [x] 削除が失敗した場合の再試行
  - [x] エラーログの記録

### テスト実装
- [x] 削除後の通知発火テスト
- [x] 複数通知の一括削除テスト
- [x] バックグラウンドでの削除動作テスト

## 実装ガイドライン
- 削除処理は確実に実行されるよう、同期的に処理
- 削除失敗時はユーザーに通知
- デバッグログを充実させて問題の再現を容易に

## 完了条件（Definition of Done）
- [x] アラートを削除したら、その通知が絶対に発火しない
- [x] 削除処理のログが記録される
- [x] 削除が失敗した場合、ユーザーに通知される
- [x] テストケースが全て成功する

## テスト方法
1. アラートを作成して通知をスケジュール
2. アラートを削除
3. 通知予定時刻まで待機
4. 通知が発火しないことを確認
5. NotificationCenterで保留中の通知を確認

## 依存関係
- なし（緊急バグ修正のため独立して実装可能）

## 成果物
- AlertDeletionManager.swift（削除処理の一元管理）
- NotificationCleanupService.swift（通知の確実な削除）
- 削除処理のログ機能

## 備考
- ユーザー体験に直結する重大なバグのため、最優先で対応
- 位置情報ベースの通知も含めて全て削除されることを確認
