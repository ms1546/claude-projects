# チケット #018: 時刻表連携機能の実装

## 概要
電車の時刻表と連携し、出発駅・出発時刻・到着駅・到着時刻を設定できるようにする。到着時刻の何分前に通知するかを設定可能にする。

## 背景
- 現在は到着駅と距離/時間でしか通知設定ができない
- 実際の電車の到着時刻に基づいた通知ができない
- 遅延情報も考慮できない

## 要件
### 基本機能
1. **経路検索**
   - 出発駅と到着駅を入力
   - 出発時刻または到着時刻を指定
   - 複数の候補から選択

2. **時刻表データ**
   - リアルタイムの運行情報
   - 遅延情報の反映
   - 平日/土日祝ダイヤの区別

3. **通知設定**
   - 到着予定時刻の何分前に通知
   - 遅延時の再通知
   - 乗り換えがある場合の中間通知

### 追加機能
1. **よく使う経路**
   - 経路の保存・呼び出し
   - ワンタップでアラート設定

2. **定期利用**
   - 毎日同じ時刻の自動設定
   - 曜日指定

## API選定

### 公共交通オープンデータセンター（申請中）
- **選定理由**: 無料で商用利用可能、多数の鉄道事業者のデータを統合
- **提供データ**:
  - 時刻表データ
  - リアルタイム運行情報
  - 遅延情報
  - 駅情報
- **対応事業者**:
  - JR東日本
  - 東京メトロ
  - 都営地下鉄
  - 私鉄各社（東急、小田急、京王等）
- **制限事項**:
  - 要利用申請（申請中）
  - APIキーによる認証
  - レート制限あり

## 実装詳細

### 新規画面
1. **RouteSearchView**
   - 出発駅・到着駅入力
   - 時刻指定
   - 経路候補表示

2. **TimetableAlertSetupView**
   - 選択した経路の詳細表示
   - 通知タイミング設定
   - アラート作成

### データモデル拡張
```swift
// 新規Core Dataエンティティ
RouteAlert:
- departureStation: String
- arrivalStation: String
- departureTime: Date
- arrivalTime: Date
- routeDetails: String (JSON)
- notificationMinutesBefore: Int16
```

### 主要な変更点
1. **Alert+CoreDataClass**
   - routeAlertリレーションシップ追加

2. **AlertSetupCoordinator**
   - 時刻表ベースの設定フロー追加

3. **NotificationManager**
   - 時刻ベースの通知スケジューリング

## 受け入れ条件
- [ ] 出発駅と到着駅を指定して経路検索できる
- [ ] 実際の時刻表に基づいた到着時刻が表示される
- [ ] 到着時刻の指定した分数前に通知が来る
- [ ] 遅延情報が反映される（API対応の場合）
- [ ] よく使う経路を保存・呼び出しできる

## ステータス: [ ] Not Started / [ ] In Progress / [ ] Completed

## 実装フェーズ

### フェーズ1: API承認待ち期間の準備
1. UI/UXデザインの作成
2. データモデルの設計
3. モックデータでの画面実装

### フェーズ2: API承認後の実装
1. APIクライアントの実装
2. 実データとの連携
3. エラーハンドリング
4. パフォーマンス最適化

## 依存関係
- チケット#016（駅情報API基盤の確立）
- 公共交通オープンデータセンターのAPI承認

## 見積もり工数
- フェーズ1: 12時間（UI実装）
- フェーズ2: 8時間（API連携）
- 合計: 20時間