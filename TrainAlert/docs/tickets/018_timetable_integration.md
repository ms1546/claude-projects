# チケット #018: 時刻表連携機能の実装

## 概要
出発駅・出発時刻から到着駅・到着時刻を自動取得し、到着時刻の数分前にアラートを設定できる機能を実装する。乗換案内APIと連携し、正確な到着時刻予測を提供する。

## ステータス
- [ ] Not Started
- [ ] In Progress  
- [ ] Completed

## 背景
現在の仕様では到着駅のみを指定できるが、実際の利用シーンでは「到着時刻の何分前」という設定が必要。時刻表データと連携することで、より実用的なアラート機能を提供する。

## 詳細要件

### 1. 基本機能
- **経路検索**
  - 出発駅と到着駅の指定
  - 出発時刻または到着時刻の指定
  - 複数の経路候補から選択

- **時刻表データ取得**
  - リアルタイムの運行情報
  - 平日/土日祝日ダイヤの考慮
  - 特急/急行/各停の区別

- **アラート設定**
  - 到着予定時刻の自動計算
  - アラートタイミングの設定（到着○分前）
  - 遅延情報の反映

### 2. API候補

#### 無料API
1. **Yahoo!路線情報API** (※利用制限あり)
   - 申請必要
   - 月間リクエスト数制限
   - 詳細な乗換情報

2. **駅すぱあとWebサービス フリープラン**
   - 申請必要
   - 1日50リクエストまで
   - 基本的な経路検索機能

3. **NaviTime API** (※無料枠あり)
   - 申請必要
   - 開発用途での利用可能
   - 制限付き無料プラン

#### オープンデータ
1. **公共交通オープンデータ**
   - 一部の鉄道会社が提供
   - GTFSフォーマット
   - リアルタイム性は低い

### 3. UI/UX設計
- **アラート設定フロー**
  1. 出発駅の選択
  2. 到着駅の選択
  3. 出発時刻の入力（現在時刻がデフォルト）
  4. 経路選択
  5. アラートタイミング設定
  6. 確認・保存

- **サジェスト機能**
  - よく使う経路の記憶
  - 直近の検索履歴表示
  - 人気の経路提案

## 技術仕様
- 乗換案内APIとの連携
- 経路データのキャッシュ
- Core Dataでの履歴管理
- 遅延情報のリアルタイム更新

## タスクリスト
- [ ] API調査と選定
- [ ] API利用申請
- [ ] 経路検索機能の実装
  - [ ] APIクライアントの作成
  - [ ] 経路データモデルの定義
  - [ ] 検索処理の実装
- [ ] 時刻表データの取得・表示
  - [ ] 時刻表UIの作成
  - [ ] 経路選択画面
- [ ] アラート設定の拡張
  - [ ] 到着時刻ベースの設定
  - [ ] 出発時刻との連動
- [ ] サジェスト機能の実装
  - [ ] 履歴データの保存
  - [ ] 頻度に基づく提案
- [ ] 遅延情報の反映
- [ ] UI/UXの実装
  - [ ] 新しい設定フローの作成
  - [ ] 既存UIとの統合
- [ ] エラーハンドリング
- [ ] テストの作成

## 要件定義・設計書の更新
- [ ] requirements.mdに時刻表連携機能を追加
- [ ] technical_specification.mdにAPI仕様を追加
- [ ] ui_design.mdに新しい画面フローを追加

## 依存関係
- チケット#016（駅データAPI統合）- 関連あり
- チケット#009（アラート設定フロー）- 完了済み

## 完了条件
- [ ] 出発駅から到着駅までの経路が検索できる
- [ ] 到着予定時刻が正確に取得できる
- [ ] 到着時刻の○分前にアラートが設定できる
- [ ] 遅延情報が反映される
- [ ] API制限内で実用的に動作する
- [ ] すべてのテストがパス

## 見積もり工数
- 5-7日（API申請期間を除く）

## リスク
- API制限による機能制限
- 無料プランでの利用可能性
- 遅延情報の精度
- 複雑なUIによるUX低下

## 注意事項
- API利用規約の厳守
- 個人情報（移動履歴）の適切な管理
- オフライン時の動作考慮
- 将来的な有料API移行の可能性を考慮した設計