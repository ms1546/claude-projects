# Ticket #025: 遅延対応機能

## 概要
リアルタイム遅延情報を取得し、通知時刻を自動調整する機能を実装する。

## 優先度: Medium
## 見積もり: 12h
## ステータス: [ ] Not Started / [ ] In Progress / [ ] Completed

## タスク
### API実装
- [ ] Train API（リアルタイム情報）クライアント実装
  - [ ] エンドポイント定義
  - [ ] リクエストパラメータ設定
  - [ ] レスポンスモデル定義
  - [ ] エラーハンドリング
- [ ] 遅延情報データモデル
  - [ ] TrainInfo構造体定義
  - [ ] 遅延時間の解析
  - [ ] 現在位置情報の取得

### ビジネスロジック
- [ ] 遅延情報の定期取得機能
  - [ ] バックグラウンドタスク設定
  - [ ] 取得間隔の最適化
  - [ ] API呼び出し制限対応
- [ ] 通知時刻の動的調整ロジック
  - [ ] 遅延時間の計算
  - [ ] 通知時刻の再計算
  - [ ] 既存通知のキャンセルと再登録
- [ ] 遅延発生時の再通知
  - [ ] 遅延検知ロジック
  - [ ] 追加通知の生成
  - [ ] ユーザーへの通知内容

### UI実装
- [ ] 遅延情報表示UI
  - [ ] 現在の遅延状況表示
  - [ ] 調整後の到着予定時刻
  - [ ] 視覚的な遅延インジケータ
- [ ] 遅延通知設定UI
  - [ ] 遅延通知のON/OFF
  - [ ] 通知閾値の設定（○分以上の遅延）
  - [ ] 通知方法の選択

### データ層実装
- [ ] 遅延情報のキャッシング
  - [ ] メモリキャッシュ実装
  - [ ] 有効期限管理
  - [ ] キャッシュ更新ロジック
- [ ] バックグラウンドでの遅延チェック
  - [ ] BGTaskScheduler設定
  - [ ] 効率的なAPI呼び出し
  - [ ] バッテリー消費の最適化

## 実装ガイドライン
- リアルタイムAPIの制限を考慮した実装
- 遅延情報は最低5分間隔で更新
- 大幅遅延（30分以上）は特別扱い
- オフライン時は最後の情報を保持

## 完了条件（Definition of Done）
- [ ] 遅延情報が取得できる
- [ ] 遅延に応じて通知時刻が調整される
- [ ] 遅延情報がUIに表示される
- [ ] 大幅遅延時は別途通知される

## テスト方法
1. 実際の遅延発生時の動作確認
2. 通知時刻の自動調整確認
3. バックグラウンドでの更新確認
4. API制限時の動作確認

## 依存関係
- チケット#022（基本実装）

## 成果物
- TrainRealtimeAPIClient.swift
- DelayInfo.swift
- DelayNotificationManager.swift
- DelayStatusView.swift

## 備考
- ODPT APIのリアルタイム情報を活用
- ユーザー体験を損なわない更新頻度