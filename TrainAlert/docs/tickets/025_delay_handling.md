# Ticket #025: 遅延対応機能

## 概要
リアルタイム遅延情報を取得し、通知時刻を自動調整する機能を実装する。

## 優先度: Medium
## 見積もり: 12h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 実装完了日
2025-08-21

## タスク
### API実装
- [x] Train API（リアルタイム情報）クライアント実装
  - [x] エンドポイント定義
  - [x] リクエストパラメータ設定
  - [x] レスポンスモデル定義
  - [x] エラーハンドリング
- [x] 遅延情報データモデル
  - [x] TrainInfo構造体定義
  - [x] 遅延時間の解析
  - [x] 現在位置情報の取得

### ビジネスロジック
- [x] 遅延情報の定期取得機能
  - [x] バックグラウンドタスク設定
  - [x] 取得間隔の最適化
  - [x] API呼び出し制限対応
- [x] 通知時刻の動的調整ロジック
  - [x] 遅延時間の計算
  - [x] 通知時刻の再計算
  - [x] 既存通知のキャンセルと再登録
- [x] 遅延発生時の再通知
  - [x] 遅延検知ロジック
  - [x] 追加通知の生成
  - [x] ユーザーへの通知内容

### UI実装
- [x] 遅延情報表示UI
  - [x] 現在の遅延状況表示
  - [x] 調整後の到着予定時刻
  - [x] 視覚的な遅延インジケータ
- [x] 遅延通知設定UI
  - [x] 遅延通知のON/OFF
  - [x] 通知閾値の設定（○分以上の遅延）
  - [x] 通知方法の選択

### データ層実装
- [x] 遅延情報のキャッシング
  - [x] メモリキャッシュ実装
  - [x] 有効期限管理
  - [x] キャッシュ更新ロジック
- [x] バックグラウンドでの遅延チェック
  - [x] BGTaskScheduler設定
  - [x] 効率的なAPI呼び出し
  - [x] バッテリー消費の最適化

## 実装ガイドライン
- リアルタイムAPIの制限を考慮した実装
- 遅延情報は最低5分間隔で更新
- 大幅遅延（30分以上）は特別扱い
- オフライン時は最後の情報を保持

## 完了条件（Definition of Done）
- [x] 遅延情報が取得できる
- [x] 遅延に応じて通知時刻が調整される
- [x] 遅延情報がUIに表示される
- [x] 大幅遅延時は別途通知される

## テスト方法
1. 実際の遅延発生時の動作確認
2. 通知時刻の自動調整確認
3. バックグラウンドでの更新確認
4. API制限時の動作確認

## 依存関係
- チケット#022（基本実装）

## 成果物
- TrainRealtimeAPIClient.swift
- DelayInfo.swift
- DelayNotificationManager.swift
- DelayStatusView.swift

## 備考
- ODPT APIのリアルタイム情報を活用
- ユーザー体験を損なわない更新頻度

## 実装の詳細
- ODPT APIの既存の`getTrainInfo`メソッドを活用してリアルタイム列車情報を取得
- DelayNotificationManagerクラスを新規作成し、遅延情報の管理と通知調整を実装
- TrainDelayInfo構造体で遅延情報をモデル化（trainNumber、delayMinutes、lastUpdated等）
- 5分間隔での定期更新とキャッシュ機能により、API使用量を最適化
- TimetableAlertSetupViewに遅延情報表示（DelayStatusView）を統合
- 設定画面に遅延通知設定へのリンクを追加
- HomeViewのonAppearでRouteAlertの遅延監視を自動開始