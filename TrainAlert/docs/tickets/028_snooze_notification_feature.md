# Ticket #028: スヌーズ機能（駅ごと通知）

## 概要
3駅前から一駅ごとに通知を行うスヌーズ機能を実装する。降車駅に近づくにつれて段階的に通知することで、より確実な寝過ごし防止を実現する。

## 優先度: Medium
## 見積もり: 8h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 実装開始日: 2025-08-24
## 実装完了日: 2025-08-24

## タスク
### UI実装
- [x] スヌーズ設定UI
  - [x] スヌーズON/OFFトグル
  - [x] 開始駅数の選択（1〜5駅前から選択可能）
  - [x] 通知間隔の表示（各駅ごと）
  - [x] プレビュー表示（どの駅で通知が来るか）

### データモデル実装
- [x] Core Dataモデル拡張
  - [x] isSnoozeEnabledフィールド追加
  - [x] snoozeStartStationsフィールド追加（何駅前から開始）
  - [x] snoozeNotificationIdsフィールド追加（複数通知ID管理）
  - [ ] マイグレーション対応（今後実装予定）

### ビジネスロジック
- [x] 駅数カウント機能
  - [x] 現在地から降車駅までの残り駅数計算
  - [x] 各駅通過の検知ロジック
  - [x] 駅数に応じた通知トリガー
- [x] スヌーズ通知管理
  - [x] 複数通知のスケジューリング
  - [x] 各駅での通知内容生成
  - [x] 通知IDの一元管理

### 通知実装
- [x] 段階的通知メッセージ
  - [x] 「あと3駅で到着です」
  - [x] 「あと2駅で到着です！準備を始めましょう」
  - [x] 「次の駅で降車です！お忘れ物にご注意ください」
  - [x] キャラクタースタイルの適用
- [x] 通知の音量/バイブレーション調整
  - [x] 駅数に応じた緊急度の変化
  - [x] 最終駅では強い通知

## 実装ガイドライン
- 駅数は正確にカウントできる路線のみ対応
- 通知が多すぎてうるさくならないよう配慮
- キャンセル可能な設計
- バッテリー消費に配慮

## 完了条件（Definition of Done）
- [x] スヌーズ機能をON/OFFできる
- [x] 指定した駅数前から通知が始まる
- [x] 各駅で適切な通知が表示される
- [x] 通知をタップすると詳細が確認できる

## テスト方法
1. 3駅前からのスヌーズ設定
2. 各駅での通知確認
3. 通知内容の段階的変化を確認
4. 最終駅での強調通知を確認

## 依存関係
- チケット#023（駅数ベース通知）
- チケット#025（遅延対応）※駅数カウントの正確性

## 成果物
- SnoozeSettingsView.swift
- SnoozeNotificationManager.swift
- Alert+SnoozeExtension.swift
- StationCountTracker.swift

## 備考
- 将来的には音声通知も検討
- Apple Watchとの連携も考慮

## 実装の詳細
### 実装した機能
- **Core Dataモデルの拡張**: Alert+CoreDataClassにスヌーズ関連フィールドを追加
- **SnoozeNotificationManager**: スヌーズ通知の管理クラスを新規作成
- **AlertSettingView**: スヌーズ設定UIセクションを追加（ON/OFF、開始駅数選択）
- **AlertMonitoringService**: 駅数ベースアラートチェックとの統合
- **段階的通知メッセージ**: キャラクタースタイルに応じたメッセージ生成

### 技術的詳細
- 複数の通知IDをJSON形式で保存（snoozeNotificationIds）
- 駅数に応じて通知サウンドを変更（最終駅はdefaultCritical）
- StationCountCalculatorで現在地から残り駅数を計算

### 今後の改善点
- Core Dataマイグレーション対応
- 実際の駅数計算ロジックの実装（現在はデモ用固定値）
- 通知のバッチスケジューリング最適化
