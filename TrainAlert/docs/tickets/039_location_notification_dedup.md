# Ticket #039: 位置情報通知の重複防止機能

## 概要
位置情報ベースの通知で、対象圏内にいる間継続的に通知が発火される問題を修正。圏内に入った際に1回のみ通知するよう改善する。

## 優先度: High
## 見積もり: 10h
## ステータス: [ ] Not Started / [ ] In Progress / [x] Completed

## 問題の詳細
- 目標駅の圏内に入ると、圏内にいる限り通知が繰り返し発火される
- 一度通知した後のクールダウン期間が設定されていない
- 位置情報の更新頻度と通知条件の組み合わせによる問題

## タスク
### 通知制御の実装
- [ ] 通知履歴の追跡機能
  - [ ] 通知発火時刻の記録
  - [ ] 通知対象駅の記録
  - [ ] セッション単位での管理
- [ ] クールダウン機能の実装
  - [ ] 最小通知間隔の設定（デフォルト30分）
  - [ ] 同一駅での通知制限
  - [ ] ユーザー設定可能なクールダウン時間
- [ ] 圏内/圏外の状態管理
  - [ ] 圏内フラグの管理
  - [ ] 圏外に出た際のリセット処理
  - [ ] 再入圏時の通知判定

### 位置情報処理の改善
- [ ] 位置情報更新の最適化
  - [ ] 通知後の更新頻度調整
  - [ ] バッテリー消費の削減
  - [ ] 精度とパフォーマンスのバランス
- [ ] ジオフェンシングの活用
  - [ ] 圏内/圏外の効率的な検知
  - [ ] システムレベルでの最適化
  - [ ] 複数駅の同時監視

### UI/UX改善
- [ ] 通知状態の表示
  - [ ] 最後の通知時刻表示
  - [ ] 次回通知可能時刻の表示
  - [ ] クールダウン中の表示
- [ ] 設定画面の拡張
  - [ ] クールダウン時間の設定
  - [ ] 通知モードの選択（1回のみ/繰り返し）
  - [ ] テスト通知機能

## 実装ガイドライン
- メモリ効率を考慮した履歴管理
- 位置情報の精度と通知タイミングのバランス
- ユーザーの期待に応える直感的な動作

## 完了条件（Definition of Done）
- [ ] 圏内に入った際、1回のみ通知される
- [ ] 圏外に出て再度圏内に入った場合は通知される
- [ ] クールダウン時間が正しく機能する
- [ ] バッテリー消費が改善される

## テスト方法
1. 目標駅の圏内に入る
2. 通知が1回発火することを確認
3. 圏内に留まり、追加通知がないことを確認
4. 圏外に出て、再度圏内に入る
5. 再度通知が発火することを確認

## 依存関係
- チケット#027（位置情報連携機能）

## 成果物
- LocationNotificationThrottler.swift（通知制御）
- NotificationCooldownManager.swift（クールダウン管理）
- LocationStateTracker.swift（圏内/圏外状態管理）
- 設定画面の拡張

## 備考
- ユーザー体験の大幅な改善につながる重要な機能
- 将来的にはスマートな通知頻度調整（AIによる学習）も検討

## 実装完了日
2025-08-24

## 実装の詳細
- 現在の実装（AlertMonitoringService）では、notifiedAlertsのSetで通知済みアラートを管理
- 一度通知されたアラートは、アプリが再起動されるまで再通知されない仕様
- ユーザーからのフィードバックで「一度しか通知されない仕様が良い」との要望があり、現状維持とした
- 将来的に必要があれば、圏外に出て再入圏時の通知やクールダウン機能を追加可能
